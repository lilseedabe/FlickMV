import React, { useState, useCallback, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { \n  Music, \n  Play, \n  Pause, \n  Loader, \n  CheckCircle, \n  AlertCircle, \n  Info,\n  Volume2,\n  BarChart3,\n  Zap\n} from 'lucide-react';\n\nimport { BPMDetectorProps, BPMAnalysis, MediaFile } from '../../types';\nimport { BPMDetector, loadAudioFile } from '../../utils/audio/bpmDetector';\n\n/**\n * BPMæ¤œå‡ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ\n * åˆå¿ƒè€…ã«ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„UI/UXã‚’æä¾›\n */\nconst BPMDetectorComponent: React.FC<BPMDetectorProps> = ({\n  audioFile,\n  onBPMDetected,\n  onAnalysisStart,\n  onAnalysisComplete,\n  onError\n}) => {\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n  const [progress, setProgress] = useState(0);\n  const [result, setResult] = useState<BPMAnalysis | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const [isPlaying, setIsPlaying] = useState(false);\n  const [audioContext, setAudioContext] = useState<AudioContext | null>(null);\n  const [audioBuffer, setAudioBuffer] = useState<AudioBuffer | null>(null);\n\n  // BPMæ¤œå‡ºã®å®Ÿè¡Œ\n  const detectBPM = useCallback(async () => {\n    if (!audioFile) return;\n\n    try {\n      setIsAnalyzing(true);\n      setError(null);\n      setProgress(0);\n      onAnalysisStart?.();\n\n      console.log('ğŸµ BPMæ¤œå‡ºã‚’é–‹å§‹ã—ã¾ã™');\n      \n      // é€²è¡ŒçŠ¶æ³ã®æ›´æ–°ï¼ˆUIå‘ã‘ï¼‰\n      setProgress(20);\n      \n      // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’AudioBufferã«å¤‰æ›\n      const buffer = await loadAudioFile(new File([audioFile.url], audioFile.name));\n      setAudioBuffer(buffer);\n      setProgress(40);\n      \n      // BPMæ¤œå‡ºå™¨ã®ä½œæˆã¨å®Ÿè¡Œ\n      const detector = new BPMDetector();\n      setProgress(60);\n      \n      const analysis = await detector.detectBPM(buffer);\n      setProgress(80);\n      \n      // çµæœã®ä¿å­˜ã¨é€šçŸ¥\n      setResult(analysis);\n      onBPMDetected(analysis);\n      setProgress(100);\n      \n      console.log('âœ… BPMæ¤œå‡ºå®Œäº†:', analysis);\n      \n      // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n      detector.dispose();\n      onAnalysisComplete?.();\n      \n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'BPMæ¤œå‡ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';\n      setError(errorMessage);\n      onError?.(errorMessage);\n      console.error('âŒ BPMæ¤œå‡ºã‚¨ãƒ©ãƒ¼:', err);\n    } finally {\n      setIsAnalyzing(false);\n    }\n  }, [audioFile, onBPMDetected, onAnalysisStart, onAnalysisComplete, onError]);\n\n  // éŸ³å£°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ\n  const togglePlayback = useCallback(async () => {\n    if (!audioBuffer) return;\n\n    try {\n      if (isPlaying) {\n        // åœæ­¢\n        audioContext?.suspend();\n        setIsPlaying(false);\n      } else {\n        // å†ç”Ÿ\n        const ctx = new AudioContext();\n        const source = ctx.createBufferSource();\n        source.buffer = audioBuffer;\n        source.connect(ctx.destination);\n        source.start();\n        \n        setAudioContext(ctx);\n        setIsPlaying(true);\n        \n        // å†ç”Ÿçµ‚äº†æ™‚ã®å‡¦ç†\n        source.onended = () => {\n          setIsPlaying(false);\n        };\n      }\n    } catch (err) {\n      console.error('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', err);\n    }\n  }, [audioBuffer, audioContext, isPlaying]);\n\n  // ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ\n  const getHelpText = () => {\n    if (isAnalyzing) return 'BPMã‚’è§£æä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„...';\n    if (result) return 'BPMã®æ¤œå‡ºãŒå®Œäº†ã—ã¾ã—ãŸï¼ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã§ãƒ“ãƒ¼ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’ç¢ºèªã§ãã¾ã™ã€‚';\n    if (error) return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';\n    return 'ã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€æ¥½æ›²ã®ãƒ†ãƒ³ãƒï¼ˆBPMï¼‰ã‚’è‡ªå‹•æ¤œå‡ºã—ã¾ã™ã€‚';\n  };\n\n  return (\n    <div className=\"bg-dark-800 rounded-xl p-6 border border-dark-700\">\n      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}\n      <div className=\"flex items-center space-x-3 mb-4\">\n        <div className=\"w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center\">\n          <Music className=\"w-5 h-5 text-white\" />\n        </div>\n        <div>\n          <h3 className=\"text-lg font-semibold text-white\">BPMæ¤œå‡º</h3>\n          <p className=\"text-sm text-gray-400\">æ¥½æ›²ã®ãƒ†ãƒ³ãƒã‚’è‡ªå‹•ã§è§£æ</p>\n        </div>\n      </div>\n\n      {/* éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ± */}\n      <div className=\"bg-dark-700 rounded-lg p-4 mb-4\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center space-x-3\">\n            <Volume2 className=\"w-4 h-4 text-purple-400\" />\n            <div>\n              <p className=\"text-sm font-medium text-white\">{audioFile.name}</p>\n              <p className=\"text-xs text-gray-400\">\n                {audioFile.duration ? `${Math.floor(audioFile.duration / 60)}:${(audioFile.duration % 60).toFixed(0).padStart(2, '0')}` : 'ä¸æ˜'}\n                {audioFile.size && ` â€¢ ${(audioFile.size / (1024 * 1024)).toFixed(1)}MB`}\n              </p>\n            </div>\n          </div>\n          \n          {/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿãƒœã‚¿ãƒ³ */}\n          {audioBuffer && (\n            <button\n              onClick={togglePlayback}\n              className=\"flex items-center space-x-1 bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded-lg text-sm transition-all\"\n            >\n              {isPlaying ? <Pause className=\"w-3 h-3\" /> : <Play className=\"w-3 h-3\" />}\n              <span>{isPlaying ? 'åœæ­¢' : 'è©¦è´'}</span>\n            </button>\n          )}\n        </div>\n      </div>\n\n      {/* BPMæ¤œå‡ºãƒœã‚¿ãƒ³ */}\n      <button\n        onClick={detectBPM}\n        disabled={isAnalyzing}\n        className={`w-full py-3 px-4 rounded-lg font-medium transition-all flex items-center justify-center space-x-2 ${\n          isAnalyzing\n            ? 'bg-gray-600 cursor-not-allowed'\n            : result\n            ? 'bg-green-500 hover:bg-green-600'\n            : 'bg-purple-500 hover:bg-purple-600'\n        } text-white`}\n      >\n        {isAnalyzing ? (\n          <>\n            <Loader className=\"w-4 h-4 animate-spin\" />\n            <span>è§£æä¸­... {progress}%</span>\n          </>\n        ) : result ? (\n          <>\n            <CheckCircle className=\"w-4 h-4\" />\n            <span>å†æ¤œå‡º</span>\n          </>\n        ) : (\n          <>\n            <BarChart3 className=\"w-4 h-4\" />\n            <span>BPMã‚’æ¤œå‡º</span>\n          </>\n        )}\n      </button>\n\n      {/* é€²è¡ŒçŠ¶æ³ãƒãƒ¼ */}\n      <AnimatePresence>\n        {isAnalyzing && (\n          <motion.div\n            initial={{ opacity: 0, height: 0 }}\n            animate={{ opacity: 1, height: 'auto' }}\n            exit={{ opacity: 0, height: 0 }}\n            className=\"mt-3\"\n          >\n            <div className=\"w-full bg-dark-700 rounded-full h-2\">\n              <motion.div\n                className=\"bg-purple-500 h-2 rounded-full\"\n                style={{ width: `${progress}%` }}\n                transition={{ duration: 0.3 }}\n              />\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n\n      {/* çµæœè¡¨ç¤º */}\n      <AnimatePresence>\n        {result && (\n          <motion.div\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: -10 }}\n            className=\"mt-4 bg-green-500/10 border border-green-500/30 rounded-lg p-4\"\n          >\n            <div className=\"flex items-center space-x-2 mb-3\">\n              <CheckCircle className=\"w-4 h-4 text-green-400\" />\n              <span className=\"text-sm font-medium text-green-400\">æ¤œå‡ºå®Œäº†</span>\n            </div>\n            \n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"text-center\">\n                <div className=\"text-2xl font-bold text-white\">{result.bpm}</div>\n                <div className=\"text-xs text-gray-400\">BPM</div>\n              </div>\n              <div className=\"text-center\">\n                <div className=\"text-2xl font-bold text-white\">{Math.round(result.confidence * 100)}%</div>\n                <div className=\"text-xs text-gray-400\">ä¿¡é ¼åº¦</div>\n              </div>\n            </div>\n            \n            <div className=\"mt-3 pt-3 border-t border-green-500/20\">\n              <div className=\"flex items-center justify-between text-xs text-gray-300\">\n                <span>ãƒ“ãƒ¼ãƒˆæ•°: {result.beatTimes.length}</span>\n                <span>å°ç¯€æ•°: {result.bars.length}</span>\n                <span>æ‹å­: {result.timeSignature.numerator}/{result.timeSignature.denominator}</span>\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n\n      {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}\n      <AnimatePresence>\n        {error && (\n          <motion.div\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: -10 }}\n            className=\"mt-4 bg-red-500/10 border border-red-500/30 rounded-lg p-4\"\n          >\n            <div className=\"flex items-center space-x-2 mb-2\">\n              <AlertCircle className=\"w-4 h-4 text-red-400\" />\n              <span className=\"text-sm font-medium text-red-400\">ã‚¨ãƒ©ãƒ¼</span>\n            </div>\n            <p className=\"text-sm text-gray-300\">{error}</p>\n          </motion.div>\n        )}\n      </AnimatePresence>\n\n      {/* ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ */}\n      <div className=\"mt-4 flex items-start space-x-2 text-xs text-gray-400\">\n        <Info className=\"w-3 h-3 mt-0.5 flex-shrink-0\" />\n        <p>{getHelpText()}</p>\n      </div>\n\n      {/* BPMæ¤œå‡ºå¾Œã®æ©Ÿèƒ½æ¡ˆå†… */}\n      <AnimatePresence>\n        {result && (\n          <motion.div\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: -10 }}\n            className=\"mt-4 bg-purple-500/10 border border-purple-500/30 rounded-lg p-3\"\n          >\n            <div className=\"flex items-center space-x-2 mb-2\">\n              <Zap className=\"w-3 h-3 text-purple-400\" />\n              <span className=\"text-xs font-medium text-purple-400\">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</span>\n            </div>\n            <div className=\"text-xs text-gray-300 space-y-1\">\n              <p>â€¢ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã§ãƒ“ãƒ¼ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’ç¢ºèªã§ãã¾ã™</p>\n              <p>â€¢ ãƒ“ãƒ¼ãƒˆã‚¹ãƒŠãƒƒãƒ—æ©Ÿèƒ½ã§ã‚¯ãƒªãƒƒãƒ—ã‚’æ­£ç¢ºã«é…ç½®</p>\n              <p>â€¢ BPMã«åˆã‚ã›ãŸãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½¿ç”¨å¯èƒ½</p>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n};\n\nexport default BPMDetectorComponent;"