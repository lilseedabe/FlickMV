import { BPMAnalysis, AudioAnalysis, FrequencyBand } from '../../types';\n\n/**\n * éŸ³å£°è§£æã®è£œåŠ©ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°é›†\n * åˆå¿ƒè€…ã«ã‚‚ç†è§£ã—ã‚„ã™ã„ã‚ˆã†è©³ç´°ã«ã‚³ãƒ¡ãƒ³ãƒˆ\n */\n\n/**\n * BPMã‹ã‚‰æ‹é–“éš”ã‚’è¨ˆç®—\n * @param bpm - Beats Per Minute\n * @returns æ‹é–“éš”ï¼ˆç§’ï¼‰\n */\nexport function calculateBeatInterval(bpm: number): number {\n  return 60 / bpm;\n}\n\n/**\n * BPMã‹ã‚‰å°ç¯€é–“éš”ã‚’è¨ˆç®—ï¼ˆ4/4æ‹å­ã‚’æƒ³å®šï¼‰\n * @param bpm - Beats Per Minute\n * @param timeSignature - æ‹å­è¨˜å·ã®åˆ†å­ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 4ï¼‰\n * @returns å°ç¯€é–“éš”ï¼ˆç§’ï¼‰\n */\nexport function calculateBarInterval(bpm: number, timeSignature: number = 4): number {\n  return (60 / bpm) * timeSignature;\n}\n\n/**\n * æŒ‡å®šã—ãŸæ™‚é–“ã«æœ€ã‚‚è¿‘ã„ãƒ“ãƒ¼ãƒˆã‚¿ã‚¤ãƒ ã‚’å–å¾—\n * @param time - åŸºæº–æ™‚é–“ï¼ˆç§’ï¼‰\n * @param beatTimes - ãƒ“ãƒ¼ãƒˆã‚¿ã‚¤ãƒ ã®é…åˆ—\n * @returns æœ€ã‚‚è¿‘ã„ãƒ“ãƒ¼ãƒˆã‚¿ã‚¤ãƒ \n */\nexport function getClosestBeatTime(time: number, beatTimes: number[]): number {\n  if (beatTimes.length === 0) return time;\n  \n  return beatTimes.reduce((closest, current) => {\n    return Math.abs(current - time) < Math.abs(closest - time) ? current : closest;\n  });\n}\n\n/**\n * æŒ‡å®šã—ãŸæ™‚é–“ã«æœ€ã‚‚è¿‘ã„å°ç¯€é–‹å§‹æ™‚é–“ã‚’å–å¾—\n * @param time - åŸºæº–æ™‚é–“ï¼ˆç§’ï¼‰\n * @param barTimes - å°ç¯€é–‹å§‹æ™‚é–“ã®é…åˆ—\n * @returns æœ€ã‚‚è¿‘ã„å°ç¯€é–‹å§‹æ™‚é–“\n */\nexport function getClosestBarTime(time: number, barTimes: number[]): number {\n  if (barTimes.length === 0) return time;\n  \n  return barTimes.reduce((closest, current) => {\n    return Math.abs(current - time) < Math.abs(closest - time) ? current : closest;\n  });\n}\n\n/**\n * BPMã®ä¿¡é ¼åº¦ã«åŸºã¥ãæ¨å¥¨äº‹é …ã‚’ç”Ÿæˆ\n * @param analysis - BPMè§£æçµæœ\n * @returns æ¨å¥¨äº‹é …ã®é…åˆ—\n */\nexport function generateBPMRecommendations(analysis: BPMAnalysis): string[] {\n  const recommendations: string[] = [];\n  \n  if (analysis.confidence >= 0.9) {\n    recommendations.push('BPMæ¤œå‡ºã®ç²¾åº¦ãŒéå¸¸ã«é«˜ã„ã§ã™ã€‚ãƒ“ãƒ¼ãƒˆåŒæœŸæ©Ÿèƒ½ã‚’ç©æ¥µçš„ã«æ´»ç”¨ã§ãã¾ã™ã€‚');\n  } else if (analysis.confidence >= 0.7) {\n    recommendations.push('BPMæ¤œå‡ºã®ç²¾åº¦ã¯è‰¯å¥½ã§ã™ã€‚ãƒ“ãƒ¼ãƒˆåŒæœŸæ©Ÿèƒ½ãŒæœ‰åŠ¹ã«åƒãã¾ã™ã€‚');\n  } else if (analysis.confidence >= 0.5) {\n    recommendations.push('BPMæ¤œå‡ºã®ç²¾åº¦ã¯ä¸­ç¨‹åº¦ã§ã™ã€‚æ‰‹å‹•ã§ãƒ“ãƒ¼ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’èª¿æ•´ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚');\n  } else {\n    recommendations.push('BPMæ¤œå‡ºã®ç²¾åº¦ãŒä½ã„ã§ã™ã€‚æ‰‹å‹•ã§ã®ãƒ“ãƒ¼ãƒˆè¨­å®šã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚');\n  }\n  \n  // BPMã«åŸºã¥ãæ¨å¥¨äº‹é …\n  if (analysis.bpm < 80) {\n    recommendations.push('ã‚¹ãƒ­ãƒ¼ãƒ†ãƒ³ãƒãªã®ã§ã€ã‚†ã£ãŸã‚Šã¨ã—ãŸãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒåŠ¹æœçš„ã§ã™ã€‚');\n  } else if (analysis.bpm > 140) {\n    recommendations.push('ãƒã‚¤ãƒ†ãƒ³ãƒãªã®ã§ã€ã‚¯ã‚¤ãƒƒã‚¯ã‚«ãƒƒãƒˆã‚„æ¿€ã—ã„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒæ˜ ãˆã¾ã™ã€‚');\n  }\n  \n  // ãƒ“ãƒ¼ãƒˆæ•°ã«åŸºã¥ãæ¨å¥¨äº‹é …\n  if (analysis.beatTimes.length > 100) {\n    recommendations.push('ååˆ†ãªãƒ“ãƒ¼ãƒˆæ•°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ç´°ã‹ãªãƒ“ãƒ¼ãƒˆåŒæœŸç·¨é›†ãŒå¯èƒ½ã§ã™ã€‚');\n  }\n  \n  return recommendations;\n}\n\n/**\n * å‘¨æ³¢æ•°å¸¯åŸŸã®è§£æçµæœã‹ã‚‰æ¨å¥¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ææ¡ˆ\n * @param bands - å‘¨æ³¢æ•°å¸¯åŸŸã®é…åˆ—\n * @returns æ¨å¥¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®é…åˆ—\n */\nexport function suggestEffectsFromFrequency(bands: FrequencyBand[]): string[] {\n  const suggestions: string[] = [];\n  \n  bands.forEach(band => {\n    if (band.triggered) {\n      switch (band.name.toLowerCase()) {\n        case 'bass':\n        case 'sub_bass':\n        case 'kick':\n          suggestions.push('ä½éŸ³åŸŸã§ãƒˆãƒªã‚¬ãƒ¼: ç”»é¢ã‚·ã‚§ã‚¤ã‚¯ã‚„ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒåŠ¹æœçš„');\n          break;\n        case 'highs':\n        case 'brilliance':\n        case 'presence':\n          suggestions.push('é«˜éŸ³åŸŸã§ãƒˆãƒªã‚¬ãƒ¼: ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚„ã‚°ãƒ­ã‚¦ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒãŠå‹§ã‚');\n          break;\n        case 'vocals':\n        case 'mids':\n          suggestions.push('ä¸­éŸ³åŸŸã§ãƒˆãƒªã‚¬ãƒ¼: ã‚«ãƒ©ãƒ¼ã‚°ãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚„è»½ã„ã‚ºãƒ¼ãƒ ãŒé©ã—ã¦ã„ã¾ã™');\n          break;\n        case 'snare':\n          suggestions.push('ã‚¹ãƒã‚¢éŸ³ã§ãƒˆãƒªã‚¬ãƒ¼: ç¬é–“çš„ãªã‚«ãƒƒãƒˆã‚„ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãŒãƒªã‚ºãƒ æ„Ÿã‚’æ¼”å‡º');\n          break;\n      }\n    }\n  });\n  \n  return [...new Set(suggestions)]; // é‡è¤‡ã‚’é™¤å»\n}\n\n/**\n * éŸ³æ¥½ã‚¸ãƒ£ãƒ³ãƒ«ã‚’BPMã‹ã‚‰æ¨æ¸¬\n * @param bpm - Beats Per Minute\n * @returns æ¨æ¸¬ã•ã‚Œã‚‹ã‚¸ãƒ£ãƒ³ãƒ«\n */\nexport function guessGenreFromBPM(bpm: number): string {\n  if (bpm < 70) return 'Ambient/Downtempo';\n  if (bpm < 90) return 'Hip-Hop/Trap';\n  if (bpm < 100) return 'Lo-fi/Chill';\n  if (bpm < 120) return 'Pop/Rock';\n  if (bpm < 130) return 'House/Dance';\n  if (bpm < 140) return 'Techno/Trance';\n  if (bpm < 160) return 'Drum & Bass';\n  if (bpm < 180) return 'Hardcore/Gabber';\n  return 'Speedcore';\n}\n\n/**\n * ãƒ“ãƒ¼ãƒˆã‚¿ã‚¤ãƒ ã®é…åˆ—ã‹ã‚‰è¦å‰‡æ€§ã‚’åˆ†æ\n * @param beatTimes - ãƒ“ãƒ¼ãƒˆã‚¿ã‚¤ãƒ ã®é…åˆ—\n * @returns è¦å‰‡æ€§ã®åˆ†æçµæœ\n */\nexport function analyzeBeatRegularity(beatTimes: number[]): {\n  averageInterval: number;\n  standardDeviation: number;\n  regularity: 'very_regular' | 'regular' | 'irregular' | 'very_irregular';\n} {\n  if (beatTimes.length < 2) {\n    return {\n      averageInterval: 0,\n      standardDeviation: 0,\n      regularity: 'very_irregular'\n    };\n  }\n  \n  // é–“éš”ã®è¨ˆç®—\n  const intervals = [];\n  for (let i = 1; i < beatTimes.length; i++) {\n    intervals.push(beatTimes[i] - beatTimes[i - 1]);\n  }\n  \n  // å¹³å‡é–“éš”\n  const averageInterval = intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length;\n  \n  // æ¨™æº–åå·®\n  const variance = intervals.reduce((sum, interval) => {\n    return sum + Math.pow(interval - averageInterval, 2);\n  }, 0) / intervals.length;\n  const standardDeviation = Math.sqrt(variance);\n  \n  // è¦å‰‡æ€§ã®åˆ¤å®š\n  const coefficientOfVariation = standardDeviation / averageInterval;\n  let regularity: 'very_regular' | 'regular' | 'irregular' | 'very_irregular';\n  \n  if (coefficientOfVariation < 0.05) {\n    regularity = 'very_regular';\n  } else if (coefficientOfVariation < 0.1) {\n    regularity = 'regular';\n  } else if (coefficientOfVariation < 0.2) {\n    regularity = 'irregular';\n  } else {\n    regularity = 'very_irregular';\n  }\n  \n  return {\n    averageInterval,\n    standardDeviation,\n    regularity\n  };\n}\n\n/**\n * ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”Ÿæ™‚é–“ã‹ã‚‰BPMã‚’æ¦‚ç®—\n * @param duration - éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®é•·ã•ï¼ˆç§’ï¼‰\n * @param estimatedBeats - æ¨å®šã•ã‚Œã‚‹ãƒ“ãƒ¼ãƒˆæ•°\n * @returns æ¦‚ç®—BPM\n */\nexport function estimateBPMFromDuration(duration: number, estimatedBeats: number): number {\n  const beatsPerSecond = estimatedBeats / duration;\n  return Math.round(beatsPerSecond * 60);\n}\n\n/**\n * BPMã®å¤‰æ›´ã«åˆã‚ã›ã¦ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´\n * @param originalBPM - å…ƒã®BPM\n * @param newBPM - æ–°ã—ã„BPM\n * @param effectDuration - ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ç¶™ç¶šæ™‚é–“ï¼ˆç§’ï¼‰\n * @returns èª¿æ•´ã•ã‚ŒãŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆç¶™ç¶šæ™‚é–“\n */\nexport function adjustEffectForBPM(originalBPM: number, newBPM: number, effectDuration: number): number {\n  const ratio = originalBPM / newBPM;\n  return effectDuration * ratio;\n}\n\n/**\n * ãƒ“ãƒ¼ãƒˆã‚°ãƒªãƒƒãƒ‰ã®ã‚¹ãƒŠãƒƒãƒ—è·é›¢ã‚’è¨ˆç®—\n * @param pixelsPerSecond - 1ç§’ã‚ãŸã‚Šã®ãƒ”ã‚¯ã‚»ãƒ«æ•°\n * @param bpm - Beats Per Minute\n * @param subdivisions - ã‚µãƒ–ãƒ‡ã‚£ãƒ“ã‚¸ãƒ§ãƒ³ï¼ˆ1, 2, 4, 8, 16ï¼‰\n * @returns ã‚¹ãƒŠãƒƒãƒ—è·é›¢ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰\n */\nexport function calculateSnapDistance(pixelsPerSecond: number, bpm: number, subdivisions: number): number {\n  const beatInterval = 60 / bpm;\n  const subdivisionInterval = beatInterval / subdivisions;\n  return subdivisionInterval * pixelsPerSecond;\n}\n\n/**\n * å‘¨æ³¢æ•°è§£æçµæœã‹ã‚‰éŸ³æ¥½ã®ç‰¹å¾´ã‚’æŠ½å‡º\n * @param analysis - éŸ³å£°è§£æçµæœ\n * @returns éŸ³æ¥½ã®ç‰¹å¾´\n */\nexport function extractMusicFeatures(analysis: AudioAnalysis): {\n  bassHeavy: boolean;\n  treblySound: boolean;\n  dynamicRange: 'low' | 'medium' | 'high';\n  brightness: number;\n} {\n  const bassEnergy = analysis.frequencyBands\n    .filter(band => ['BASS', 'SUB_BASS', 'KICK'].includes(band.name))\n    .reduce((sum, band) => sum + band.energy, 0) / 3;\n  \n  const trebleEnergy = analysis.frequencyBands\n    .filter(band => ['HIGHS', 'BRILLIANCE', 'PRESENCE'].includes(band.name))\n    .reduce((sum, band) => sum + band.energy, 0) / 3;\n  \n  const dynamicRange = analysis.peak - analysis.rms;\n  let dynamicRangeCategory: 'low' | 'medium' | 'high';\n  \n  if (dynamicRange < 0.3) {\n    dynamicRangeCategory = 'low';\n  } else if (dynamicRange < 0.6) {\n    dynamicRangeCategory = 'medium';\n  } else {\n    dynamicRangeCategory = 'high';\n  }\n  \n  return {\n    bassHeavy: bassEnergy > 0.6,\n    treblySound: trebleEnergy > 0.6,\n    dynamicRange: dynamicRangeCategory,\n    brightness: analysis.spectralCentroid\n  };\n}\n\n/**\n * ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šBPMè§£æçµæœã‚’èª­ã¿ã‚„ã™ã„å½¢å¼ã§å‡ºåŠ›\n * @param analysis - BPMè§£æçµæœ\n */\nexport function debugBPMAnalysis(analysis: BPMAnalysis): void {\n  console.group('ğŸµ BPMè§£æçµæœ');\n  console.log(`BPM: ${analysis.bpm}`);\n  console.log(`ä¿¡é ¼åº¦: ${(analysis.confidence * 100).toFixed(1)}%`);\n  console.log(`ãƒ“ãƒ¼ãƒˆæ•°: ${analysis.beatTimes.length}`);\n  console.log(`å°ç¯€æ•°: ${analysis.bars.length}`);\n  console.log(`æ‹å­: ${analysis.timeSignature.numerator}/${analysis.timeSignature.denominator}`);\n  \n  const regularity = analyzeBeatRegularity(analysis.beatTimes);\n  console.log(`ãƒ“ãƒ¼ãƒˆã®è¦å‰‡æ€§: ${regularity.regularity}`);\n  console.log(`å¹³å‡ãƒ“ãƒ¼ãƒˆé–“éš”: ${regularity.averageInterval.toFixed(3)}ç§’`);\n  \n  const genre = guessGenreFromBPM(analysis.bpm);\n  console.log(`æ¨æ¸¬ã‚¸ãƒ£ãƒ³ãƒ«: ${genre}`);\n  \n  console.groupEnd();\n}"